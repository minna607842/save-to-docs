(()=>{"use strict";document.addEventListener("DOMContentLoaded",(()=>{const t=document.getElementById("mainView"),e=document.getElementById("setupView"),o=document.getElementById("saveButton"),n=document.getElementById("setupButton"),c=document.getElementById("createNewDoc"),r=document.getElementById("docIdInput"),s=document.getElementById("errorText"),a=document.getElementById("resetUrlsButton");async function l(){console.log("Checking Doc ID");const o=await chrome.storage.local.get("documentId");return console.log("Got Doc ID:",o),o.documentId?(t.style.display="block",e.style.display="none"):(t.style.display="none",e.style.display="block"),o.documentId}console.log("DOM Loaded"),n?.addEventListener("click",(async()=>{console.log("Setup button clicked");const t=r.value.trim();t?(await chrome.storage.local.set({documentId:t}),await l()):s.textContent="Document IDを入力してください"})),c?.addEventListener("click",(async function(){try{console.log("Creating new document");const t=await chrome.identity.getAuthToken({interactive:!0}),e=await fetch("https://docs.googleapis.com/v1/documents",{method:"POST",headers:{Authorization:`Bearer ${t.token}`,"Content-Type":"application/json"},body:JSON.stringify({title:"Web Page Archives"})});if(!e.ok)throw new Error("ドキュメントの作成に失敗しました");const o=await e.json();await chrome.storage.local.set({documentId:o.documentId,documentState:{lastIndex:1,documentId:o.documentId,urlStates:{}}}),alert(`新規ドキュメントを作成しました！\nDocument ID: ${o.documentId}`),await l()}catch(t){console.error("Error creating document:",t),s.textContent=t instanceof Error?t.message:"不明なエラーが発生しました"}})),o&&o.addEventListener("click",(async()=>{console.log("Save button clicked");const t=await l();console.log("Got docId:",t),t?await async function(t){try{console.log("Starting save process with document ID:",t),console.log("Attempting to get auth token...");const e=await chrome.identity.getAuthToken({interactive:!0}).catch((t=>{throw console.error("Auth token error:",t),new Error("認証に失敗しました: "+t.message)}));console.log("Got auth token successfully"),console.log("Getting current tab info...");const[o]=await chrome.tabs.query({active:!0,currentWindow:!0}).catch((t=>{throw console.error("Tab query error:",t),new Error("タブ情報の取得に失敗しました")}));if(!o.id)throw console.error("No tab ID found"),new Error("タブIDが見つかりません");console.log("Got tab info:",o.id),console.log("Executing content script...");const n=(await chrome.scripting.executeScript({target:{tabId:o.id},func:()=>{const t=window.getSelection()?.toString()||"";return{title:document.title,content:t||document.body.innerText,url:document.location.href,isSelection:!!t}}}).catch((t=>{throw console.error("Script execution error:",t),new Error("ページ内容の取得に失敗しました")})))[0].result,{savedUrls:c=[]}=await chrome.storage.local.get("savedUrls");console.log("Saved URLs:",c),console.log("Current URL:",n.url);const r=c.includes(n.url);console.log("URL exists?:",r),console.log("Got page data:",{title:n.title.substring(0,50)+"...",contentLength:n.content.length,url:n.url,isSelection:n.isSelection});const{documentState:s={lastIndex:1,documentId:t,urlStates:{}}}=await chrome.storage.local.get("documentState"),a=Date.now(),l=s.urlStates[n.url],i=216e5;let d,u=1;if(r&&l&&a-l.lastUpdateTime<i){u=s.lastIndex,d=`\n${n.content}\n`;const t=u+d.length;s.lastIndex=t,s.urlStates[n.url]={lastIndex:u,lastUpdateTime:a}}else u=1,d=`\n-------------------\n${(new Date).toLocaleString()}\n${n.title}\n${n.url}\n${n.content}\n`,s.lastIndex=d.length+1,s.urlStates[n.url]={lastIndex:u,lastUpdateTime:a};const g=await fetch(`https://docs.googleapis.com/v1/documents/${t}:batchUpdate`,{method:"POST",headers:{Authorization:`Bearer ${e.token}`,"Content-Type":"application/json"},body:JSON.stringify({requests:[{insertText:{location:{index:u},text:d}}]})});if(!g.ok){const t=await g.json();throw console.error("Google Docs API error:",t),new Error(`Google Docsへの保存に失敗しました: ${g.status} ${g.statusText}`)}await chrome.storage.local.set({documentState:s}),r||(c.push(n.url),c.length>1e3&&c.splice(0,c.length-1e3),await chrome.storage.local.set({savedUrls:c})),console.log("Successfully saved to Google Docs"),alert("保存が完了しました！")}catch(t){console.error("Full error details:",t);const e=t instanceof Error?t.message:"不明なエラーが発生しました";console.error("Formatted error message:",e),alert("エラーが発生しました: "+e)}}(t):(console.log("No document ID configured"),alert("Document IDが設定されていません"))})),a?.addEventListener("click",(async()=>{try{const t=await l();if(!t)return void alert("Document IDが設定されていません");await chrome.storage.local.set({savedUrls:[],documentState:{lastIndex:1,documentId:t,urlStates:{}}}),alert("URL履歴をリセットしました")}catch(t){console.error("Error resetting URLs:",t),alert("リセット中にエラーが発生しました")}})),l().catch(console.error)}))})();